<!DOCTYPE html>
<html>
  <head>

    <style type="text/css">

      p.error {
        margin-top: 0.2em;
        margin-bottom: 0.2em;
        background-color: #f55;
      }

      /*
      table.directory {
        border-collapse: collapse;
        border: solid 2px;
        width: 10em;
        background-color: #eee;
      }

      table.directory tr:hover {
        background-color: #fa3;
      }

      table.directory td {
        padding: 0.25em;
        border: solid 1px;
      }

      table.directory th {
        padding: 0.25em;
        border: solid 1px;
        background-color: yellow;
      }

      table.directory th.name {
        text-align: left;
      }

      table.directory td.name {
        min-width: 10em;
      }

      table.directory td.size {
        text-align: right;
        min-width: 6em;
      }
      */

      div#container {
        text-align: center;
      }
      
      div.directory div {
        padding: 0.1em;
        overflow: hidden;
      }
      
      div.directory {
        width: 50%;
        background-color: #eee;
        display: inline-block;
        text-align: left;
        -webkit-column-count: 3;
      }
      
      div.directory * {
        cursor: pointer;
      }
      
      div.directory div.folder {
        margin: 2px;
        background-color: #5d2;
        border: solid 1px #881;
      }
      
    </style>

    <script type="text/javascript">

      function get_appropriate_ws_url()
      {
        var pcol;
        var u = document.URL;

        /*
         * We open the websocket encrypted if this page came on an
         * https:// url itself, otherwise unencrypted
         */

        if (u.substring(0, 5) == "https") {
          pcol = "wss://";
          u = u.substr(8);
        } else {
          pcol = "ws://";
          if (u.substring(0, 4) == "http")
            u = u.substr(7);
        }

        u = u.split('/');

        return pcol + u[0];
      }

      function read_directory( path )
      {
        var url = get_appropriate_ws_url();
        url += path;
        console.log( url );

        var websock = new WebSocket( url, "file-access-protocol" );

        try {
          websock.onopen = function() {
            console.log( "websocket connection opened" );
            document.getElementById("output").innerHTML = '';
          }

          websock.onmessage = function got_packet(msg) {
            var data = JSON.parse( msg.data );
            console.log( "directory = " + data.isDirectory );
            var div = document.createElement("div");
            div.className = data.isDirectory ? "folder" : "file";
            div.appendChild( document.createTextNode( data.name ) );
            // TODO: handle "." and ".." correctly
            div.path = path + '/' + data.name;
            if ( data.isDirectory ) 
            {
              div.addEventListener( 'click', function() {
                read_directory( this.path );
              }, false );
            }
            document.getElementById("output").appendChild( div );
          }

          websock.onclose = function(){
            console.log( "websocket connection CLOSED" );
          }

        } catch(exception) {
          alert('<p>Error' + exception + '</p>');
        }
      }

      function init()
      {
        read_directory( '/c/' );
      }

    </script>

  </head>
  <body onload="init()">
    <h1 align="center">Local Proxy test page</h1>
    <div id="container">
      <div id="output" class="directory">
      </div>
    </div>
  </body>
</html>